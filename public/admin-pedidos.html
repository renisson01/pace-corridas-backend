<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE Admin â€” Pedidos</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>body{background:#0f172a;}</style>
</head>
<body class="text-white min-h-screen pb-24">
<header class="bg-slate-800 border-b border-slate-700 px-4 py-3 flex justify-between items-center sticky top-0 z-40">
  <h1 class="font-black text-green-400">ğŸ“¦ Pedidos do Dia</h1>
  <button onclick="location.reload()" class="text-slate-400 text-sm">ğŸ”„ Atualizar</button>
</header>

<div class="max-w-2xl mx-auto px-4 py-4">
  <!-- RESUMO DO DIA -->
  <div class="grid grid-cols-3 gap-3 mb-5">
    <div class="bg-slate-800 border border-yellow-500/30 rounded-2xl p-3 text-center">
      <p id="novos" class="text-3xl font-black text-yellow-400">0</p>
      <p class="text-xs text-slate-400 mt-1">ğŸ†• Novos</p>
    </div>
    <div class="bg-slate-800 border border-blue-500/30 rounded-2xl p-3 text-center">
      <p id="separando" class="text-3xl font-black text-blue-400">0</p>
      <p class="text-xs text-slate-400 mt-1">ğŸ“¦ Separando</p>
    </div>
    <div class="bg-slate-800 border border-green-500/30 rounded-2xl p-3 text-center">
      <p id="enviados" class="text-3xl font-black text-green-400">0</p>
      <p class="text-xs text-slate-400 mt-1">âœ… Enviados</p>
    </div>
  </div>

  <div id="loading" class="text-center py-8 text-slate-400">â³ Carregando pedidos...</div>
  <div id="lista" class="space-y-3 hidden"></div>
  <div id="vazio" class="hidden text-center py-12 text-slate-400">
    <div class="text-5xl mb-3">ğŸ˜´</div>
    <p class="font-black">Nenhum pedido ainda!</p>
    <p class="text-sm mt-2">Bom dia! Sem pedidos por enquanto.</p>
  </div>
</div>

<script>
const token = localStorage.getItem('pace_token');
const me = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;
if (!token || !me?.isAdmin) { alert('Acesso negado!'); window.location.href = '/'; }

const STATUS_CONFIG = {
  novo:      { label:'ğŸ†• Novo',      cor:'border-yellow-500/50 bg-yellow-900/20', btn:'ğŸ“¦ Separar',  prox:'separando' },
  separando: { label:'ğŸ“¦ Separando', cor:'border-blue-500/50 bg-blue-900/20',     btn:'âœ… Enviado',  prox:'enviado' },
  enviado:   { label:'âœ… Enviado',   cor:'border-green-500/50 bg-green-900/20',   btn:'ğŸ—„ï¸ Arquivar', prox:'arquivado' },
  arquivado: { label:'ğŸ—„ï¸ Arquivado', cor:'border-slate-500/50 bg-slate-800',      btn:null, prox:null },
};

async function mudarStatus(id, novoStatus) {
  await fetch(`/loja/pedidos/${id}/status`, {
    method: 'PATCH',
    headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
    body: JSON.stringify({ status: novoStatus })
  });
  load();
}

function renderPedido(p) {
  const st = STATUS_CONFIG[p.status] || STATUS_CONFIG.novo;
  const data = new Date(p.criadoEm).toLocaleDateString('pt-BR', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
  const itens = p.itens?.map(i => `${i.variante?.cor || ''} ${i.variante?.tamanho} x${i.quantidade}`).join(', ') || '';
  
  return `
  <div class="border ${st.cor} rounded-2xl p-4 ${p.visto ? '' : 'ring-1 ring-yellow-400/50'}">
    <div class="flex justify-between items-start mb-2">
      <div>
        <p class="font-black">${p.user?.name || 'Cliente'}</p>
        <p class="text-xs text-slate-400">${data}</p>
      </div>
      <div class="text-right">
        <p class="font-black text-green-400">R$ ${p.total?.toFixed(2)}</p>
        <span class="text-xs">${st.label}</span>
      </div>
    </div>
    <div class="bg-slate-900/50 rounded-xl p-2 mb-3">
      ${p.itens?.map(i => `
        <div class="flex justify-between text-sm py-1">
          <span>${i.variante?.produto?.nome || 'Produto'} â€” ${i.variante?.cor || ''} ${i.variante?.tamanho}</span>
          <span class="text-slate-400">x${i.quantidade}</span>
        </div>`).join('') || '<p class="text-xs text-slate-400">'+itens+'</p>'}
    </div>
    ${p.endereco ? `<p class="text-xs text-slate-400 mb-2">ğŸ“ ${p.endereco}, ${p.cidade}/${p.estado} â€” CEP: ${p.cep}</p>` : ''}
    ${p.obs ? `<p class="text-xs text-yellow-400 mb-2">ğŸ’¬ ${p.obs}</p>` : ''}
    <div class="flex gap-2">
      ${p.user?.phone ? `<a href="https://wa.me/${p.user.phone.replace(/\D/g,'')}?text=${encodeURIComponent('OlÃ¡ '+p.user.name+'! Seu pedido PACE estÃ¡ '+p.status+'.')}" target="_blank" class="flex-1 text-center bg-green-500/20 border border-green-500/50 text-green-400 text-xs font-bold py-2 rounded-xl">ğŸ’¬ WhatsApp</a>` : ''}
      ${st.btn ? `<button onclick="mudarStatus('${p.id}','${st.prox}')" class="flex-1 bg-blue-500/20 border border-blue-500/50 text-blue-400 text-xs font-bold py-2 rounded-xl">${st.btn}</button>` : ''}
    </div>
  </div>`;
}

async function load() {
  try {
    const r = await fetch('/loja/pedidos/admin', { headers: { Authorization:`Bearer ${token}` } });
    const pedidos = await r.json();
    document.getElementById('loading').classList.add('hidden');

    // Contar por status
    document.getElementById('novos').textContent = pedidos.filter(p => p.status==='novo').length;
    document.getElementById('separando').textContent = pedidos.filter(p => p.status==='separando').length;
    document.getElementById('enviados').textContent = pedidos.filter(p => p.status==='enviado').length;

    if (!pedidos.length) { document.getElementById('vazio').classList.remove('hidden'); return; }
    document.getElementById('lista').classList.remove('hidden');
    document.getElementById('lista').innerHTML = pedidos.map(renderPedido).join('');
  } catch(e) {
    document.getElementById('loading').innerHTML = `<p class="text-red-400">âŒ Erro: ${e.message}</p>`;
  }
}
load();
</script>
<nav class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around py-2 z-50">
  <a href="/" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
  <a href="/calendario.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
  <a href="/elite.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ†</span><span>Ranking</span></a>
  <a href="/loja.html" class="flex flex-col items-center text-xs py-1 px-2 text-green-400"><span class="text-xl">ğŸ‘•</span><span>Loja</span></a>
  <a href="/ia.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸƒ</span><span>PACE IA</span></a>
  <a href="/perfil.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
</nav>
</body>
</html>
