<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE - CalendÃ¡rio de Corridas 2026</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#22c55e">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background:#0f172a; }
  .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
  .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34,197,94,0.15); }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; }
  ::-webkit-scrollbar { width:4px; } ::-webkit-scrollbar-thumb { background:#334155; border-radius:4px; }
</style>
</head>
<body class="text-white min-h-screen">

<!-- HEADER -->
<div class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40">
  <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="/" class="flex items-center gap-2">
      <span class="text-green-400 font-black text-xl">PACE</span>
      <span class="text-slate-400 text-xs">Brasil</span>
    </a>
    <h1 class="text-sm font-bold text-slate-200">ğŸ“… CalendÃ¡rio 2026</h1>
    <a href="/organizador.html" class="bg-green-500 text-black text-xs font-black px-3 py-1.5 rounded-full">+ Evento</a>
  </div>
</div>

<!-- BUSCA E FILTROS -->
<div class="max-w-4xl mx-auto px-4 pt-4 pb-2">
  <div class="bg-slate-800 rounded-2xl p-4 space-y-3">
    
    <!-- Barra de busca -->
    <div class="relative">
      <span class="absolute left-3 top-3 text-slate-400">ğŸ”</span>
      <input id="busca" placeholder="Buscar corrida, cidade..." 
        class="w-full bg-slate-700 rounded-xl pl-9 pr-4 py-2.5 text-sm border border-slate-600 outline-none focus:border-green-500 text-white placeholder-slate-400"
        oninput="filtrar()">
    </div>

    <!-- Filtros em linha -->
    <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
      <select id="filtroEstado" onchange="filtrar()" 
        class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-xs text-white outline-none min-w-max">
        <option value="">ğŸ—ºï¸ Todos os estados</option>
        <option value="SE">Sergipe</option>
        <option value="SP">SÃ£o Paulo</option>
        <option value="RJ">Rio de Janeiro</option>
        <option value="MG">Minas Gerais</option>
        <option value="RS">Rio Grande do Sul</option>
        <option value="PR">ParanÃ¡</option>
        <option value="SC">Santa Catarina</option>
        <option value="BA">Bahia</option>
        <option value="PE">Pernambuco</option>
        <option value="CE">CearÃ¡</option>
        <option value="DF">BrasÃ­lia</option>
        <option value="GO">GoiÃ¡s</option>
        <option value="AM">Amazonas</option>
        <option value="PA">ParÃ¡</option>
      </select>

      <select id="filtroStatus" onchange="filtrar()"
        class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-xs text-white outline-none min-w-max">
        <option value="upcoming">ğŸ“… PrÃ³ximas</option>
        <option value="">Todas</option>
        <option value="completed">âœ… Realizadas</option>
      </select>

      <select id="filtroDistancia" onchange="filtrar()"
        class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-xs text-white outline-none min-w-max">
        <option value="">ğŸƒ Qualquer distÃ¢ncia</option>
        <option value="5km">5km</option>
        <option value="10km">10km</option>
        <option value="21km">Meia (21km)</option>
        <option value="42km">Maratona (42km)</option>
      </select>

      <select id="filtroMes" onchange="filtrar()"
        class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-xs text-white outline-none min-w-max">
        <option value="">ğŸ“† Todos os meses</option>
        <option value="3">MarÃ§o</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>
  </div>
</div>

<!-- CONTADOR -->
<div class="max-w-4xl mx-auto px-4 py-2">
  <p id="contador" class="text-slate-400 text-xs"></p>
</div>

<!-- LISTA DE CORRIDAS -->
<div class="max-w-4xl mx-auto px-4 pb-24">
  <div id="loading" class="text-center py-12 text-slate-400">
    <div class="text-4xl mb-3">â³</div>
    <p>Carregando corridas...</p>
  </div>
  <div id="lista" class="space-y-3 hidden"></div>
  <div id="vazio" class="hidden text-center py-12 text-slate-400">
    <div class="text-4xl mb-3">ğŸ”</div>
    <p class="font-bold">Nenhuma corrida encontrada</p>
    <p class="text-sm mt-1">Tente outros filtros</p>
    <a href="/organizador.html" class="inline-block mt-4 bg-green-500 text-black px-4 py-2 rounded-full text-sm font-bold">Cadastrar corrida</a>
  </div>
</div>

<!-- NAV BOTTOM -->
<nav class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around py-2 z-50">
  <a href="/" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
  <a href="/calendario.html" class="flex flex-col items-center text-xs py-1 px-2 text-green-400"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
  <a href="/elite.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ†</span><span>Ranking</span></a>
  <a href="/loja.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ‘•</span><span>Loja</span></a>
  <a href="/ia.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸƒ</span><span>PACE IA</span></a>
  <a href="/perfil.html" class="flex flex-col items-center text-xs py-1 px-2 text-slate-400"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
</nav>

<script>
let todasCorridas = [];

const MESES = ['','Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MESES_FULL = ['','Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

function diasAte(dateStr) {
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const data = new Date(dateStr); data.setHours(0,0,0,0);
  return Math.ceil((data-hoje)/(1000*60*60*24));
}

function badgeDistancia(d) {
  const cores = { '42km':'bg-red-500', '21km':'bg-orange-500', '15km':'bg-yellow-600', '10km':'bg-blue-500', '5km':'bg-green-500', '3km':'bg-teal-500' };
  const dist = Array.isArray(d) ? d : String(d).split(/[,\/]/);
  return dist.slice(0,4).map(x => {
    x = x.trim();
    const cor = Object.entries(cores).find(([k])=>x.includes(k))?.[1] || 'bg-slate-500';
    return `<span class="badge ${cor} text-white">${x}</span>`;
  }).join(' ');
}

function renderCard(r) {
  const data = new Date(r.date);
  const dias = diasAte(r.date);
  const dia = data.getDate();
  const mes = MESES[data.getMonth()+1];
  const ano = data.getFullYear();
  const concluida = r.status === 'completed' || dias < 0;
  
  let diasBadge = '';
  if(!concluida) {
    if(dias === 0) diasBadge = `<span class="badge bg-red-500 text-white">HOJE!</span>`;
    else if(dias === 1) diasBadge = `<span class="badge bg-orange-500 text-white">AMANHÃƒ</span>`;
    else if(dias <= 7) diasBadge = `<span class="badge bg-yellow-500 text-black">${dias} dias</span>`;
    else if(dias <= 30) diasBadge = `<span class="badge bg-blue-600 text-white">${dias} dias</span>`;
    else diasBadge = `<span class="badge bg-slate-600 text-slate-300">${dias} dias</span>`;
  }

  const linkBtn = r.registrationUrl 
    ? `<a href="${r.registrationUrl}" target="_blank" class="bg-green-500 hover:bg-green-400 text-black font-black text-xs px-4 py-2 rounded-full whitespace-nowrap">Inscrever-se â†’</a>`
    : concluida 
      ? `<span class="text-slate-500 text-xs">Encerrada</span>`
      : `<span class="text-slate-400 text-xs italic">Em breve</span>`;

  return `
  <div class="card-hover bg-slate-800 border border-slate-700 rounded-2xl p-4 flex gap-4">
    <!-- Data -->
    <div class="flex flex-col items-center justify-center bg-slate-700 rounded-xl px-3 py-2 min-w-[52px] text-center">
      <span class="text-green-400 font-black text-xl leading-none">${dia}</span>
      <span class="text-slate-300 text-xs font-bold">${mes}</span>
      <span class="text-slate-500 text-xs">${ano}</span>
    </div>
    
    <!-- Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-start justify-between gap-2 mb-1">
        <h3 class="font-bold text-sm leading-tight">${r.name}</h3>
        ${diasBadge}
      </div>
      <p class="text-slate-400 text-xs mb-2">ğŸ“ ${r.city}/${r.state} Â· ${r.organizer||''}</p>
      <div class="flex items-center justify-between">
        <div class="flex gap-1 flex-wrap">${badgeDistancia(r.distances)}</div>
        ${linkBtn}
      </div>
    </div>
  </div>`;
}

function filtrar() {
  const busca = document.getElementById('busca').value.toLowerCase();
  const estado = document.getElementById('filtroEstado').value;
  const status = document.getElementById('filtroStatus').value;
  const distancia = document.getElementById('filtroDistancia').value;
  const mes = document.getElementById('filtroMes').value;

  let filtradas = todasCorridas.filter(r => {
    if(busca && !r.name.toLowerCase().includes(busca) && !r.city?.toLowerCase().includes(busca)) return false;
    if(estado && r.state !== estado) return false;
    if(status === 'upcoming' && (r.status === 'completed' || diasAte(r.date) < 0)) return false;
    if(status === 'completed' && r.status !== 'completed' && diasAte(r.date) >= 0) return false;
    if(distancia) {
      const d = Array.isArray(r.distances) ? r.distances.join(',') : String(r.distances);
      if(!d.includes(distancia)) return false;
    }
    if(mes) {
      const m = new Date(r.date).getMonth()+1;
      if(String(m) !== mes) return false;
    }
    return true;
  });

  // Ordenar por data
  filtradas.sort((a,b) => new Date(a.date) - new Date(b.date));

  document.getElementById('contador').textContent = `${filtradas.length} corrida${filtradas.length!==1?'s':''} encontrada${filtradas.length!==1?'s':''}`;
  
  const lista = document.getElementById('lista');
  if(filtradas.length === 0) {
    lista.classList.add('hidden');
    document.getElementById('vazio').classList.remove('hidden');
  } else {
    document.getElementById('vazio').classList.add('hidden');
    lista.classList.remove('hidden');
    lista.innerHTML = filtradas.map(renderCard).join('');
  }
}

async function carregar() {
  try {
    // Buscar todas as corridas
    const res = await fetch('/races?limit=500');
    const data = await res.json();
    todasCorridas = Array.isArray(data) ? data : (data.races || data.data || []);
    
    document.getElementById('loading').classList.add('hidden');
    
    // Aplicar filtro inicial (prÃ³ximas)
    filtrar();
    
  } catch(e) {
    document.getElementById('loading').innerHTML = '<p class="text-red-400">âŒ Erro ao carregar. <button onclick="carregar()" class="underline">Tentar novamente</button></p>';
  }
}

carregar();
</script>
</body>
</html>
