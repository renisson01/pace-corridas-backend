<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PACE IA</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f172a;font-family:system-ui,sans-serif;}
#chat{scroll-behavior:smooth;}
.msg-ia{animation:slideIn .2s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.typing span{display:inline-block;width:7px;height:7px;border-radius:50%;background:#22c55e;margin:0 2px;animation:bounce 1s infinite;}
.typing span:nth-child(2){animation-delay:.2s;}
.typing span:nth-child(3){animation-delay:.4s;}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-8px)}}
</style>
</head>
<body class="text-white min-h-screen flex flex-col">

<!-- HEADER -->
<header class="bg-slate-800 border-b border-slate-700 px-4 py-3 flex items-center gap-3 sticky top-0 z-40">
  <a href="/" class="text-slate-400 text-xl">â†</a>
  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-700 flex items-center justify-center text-2xl flex-shrink-0">ğŸƒ</div>
  <div>
    <p class="font-black text-sm leading-none">PACE IA</p>
    <p class="text-xs text-green-400 leading-none mt-0.5">â— Sua amiga de corrida</p>
  </div>
  <a href="/ia-avatar.html" class="ml-auto text-xs text-slate-400 border border-slate-600 rounded-full px-3 py-1.5">ğŸ‘¤ Meu perfil</a>
</header>

<!-- ATALHOS -->
<div class="px-3 py-2 flex gap-2 overflow-x-auto border-b border-slate-800 flex-shrink-0" id="atalhos">
  <button onclick="rapido('Preciso escolher uma camisa, pode me ajudar?')"    class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ‘• Quero uma camisa</button>
  <button onclick="rapido('Como melhorar meu pace nos 10km?')"                class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">âš¡ Melhorar pace</button>
  <button onclick="rapido('Tive uma lesÃ£o no joelho, o que faÃ§o?')"           class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ¥ Tive lesÃ£o</button>
  <button onclick="rapido('Como me preparar para minha primeira maratona?')"  class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ† Maratona</button>
  <button onclick="rapido('Estou sem motivaÃ§Ã£o para treinar hoje')"            class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ’ª MotivaÃ§Ã£o</button>
  <button onclick="rapido('Dicas de nutriÃ§Ã£o para corredores')"               class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ¥— NutriÃ§Ã£o</button>
  <button onclick="rapido('Como dormir melhor para recuperar dos treinos?')"  class="chip whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full">ğŸ˜´ RecuperaÃ§Ã£o</button>
</div>

<!-- MENSAGENS -->
<div id="chat" class="flex-1 overflow-y-auto px-4 py-4 space-y-4" style="padding-bottom:80px;">
  <div class="flex gap-3">
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-700 flex items-center justify-center flex-shrink-0 text-base">ğŸƒ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-xs">
      <p class="text-sm" id="boas-vindas">OlÃ¡! ğŸ‘‹ Sou a PACE IA, sua amiga pessoal de corrida!</p>
      <p class="text-sm mt-2">Estou aqui para te ajudar com treinos, saÃºde, motivaÃ§Ã£o e atÃ© na escolha da sua camisa. ğŸ‘•</p>
      <p class="text-sm mt-2 text-green-400 font-bold">Como posso te ajudar hoje?</p>
    </div>
  </div>
</div>

<!-- INPUT FIXO NO FUNDO -->
<div class="fixed left-0 right-0 bg-slate-900 border-t border-slate-700 px-3 py-3" style="bottom:56px;z-index:50;">
  <div class="flex gap-2 max-w-2xl mx-auto">
    <input id="input"
      type="text"
      placeholder="Digite sua mensagem..."
      maxlength="500"
      autocomplete="off"
      class="flex-1 bg-slate-800 border border-slate-600 rounded-2xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500 transition-colors"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviar()}"
    >
    <button onclick="enviar()" id="btnEnviar"
      class="bg-green-500 hover:bg-green-400 text-black font-black w-12 h-12 rounded-2xl flex items-center justify-center text-xl transition-all active:scale-95 flex-shrink-0">
      â†‘
    </button>
  </div>
</div>

<!-- NAV -->
<nav class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around py-2 z-50">
  <a href="/" class="flex flex-col items-center text-xs text-slate-400 py-1 px-2"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
  <a href="/calendario.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-2"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
  <a href="/elite.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-2"><span class="text-xl">ğŸ†</span><span>Ranking</span></a>
  <a href="/loja.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-2"><span class="text-xl">ğŸ‘•</span><span>Loja</span></a>
  <a href="/ia.html" class="flex flex-col items-center text-xs text-green-400 py-1 px-2"><span class="text-xl">ğŸƒ</span><span>PACE IA</span></a>
  <a href="/perfil.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-2"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
</nav>

<script>
const token = localStorage.getItem('pace_token');
const me = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;
if (!token) { window.location.href = '/entrar.html'; }

// Personalizar boas vindas
if (me?.name) {
  const nome = me.name.split(' ')[0];
  document.getElementById('boas-vindas').textContent = `OlÃ¡, ${nome}! ğŸ‘‹ Sou a PACE IA, sua amiga pessoal de corrida!`;
}

const chat = document.getElementById('chat');
const input = document.getElementById('input');
let enviando = false;

function addMsgUser(txt) {
  const d = document.createElement('div');
  d.className = 'flex justify-end';
  d.innerHTML = `<div class="bg-green-500 text-black rounded-2xl rounded-tr-none px-4 py-3 max-w-xs"><p class="text-sm font-medium">${txt.replace(/</g,'&lt;')}</p></div>`;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function addMsgIA(txt) {
  const d = document.createElement('div');
  d.className = 'flex gap-3 msg-ia';
  // Converter quebras de linha
  const html = txt.replace(/</g,'&lt;').replace(/\n/g,'<br>');
  d.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-700 flex items-center justify-center flex-shrink-0 text-base">ğŸƒ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-xs">
      <p class="text-sm leading-relaxed">${html}</p>
    </div>`;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function addTyping() {
  const d = document.createElement('div');
  d.id = 'typing';
  d.className = 'flex gap-3';
  d.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-700 flex items-center justify-center flex-shrink-0 text-base">ğŸƒ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3">
      <div class="typing"><span></span><span></span><span></span></div>
    </div>`;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

async function enviar() {
  const txt = input.value.trim();
  if (!txt || enviando) return;
  enviando = true;
  input.value = '';
  document.getElementById('btnEnviar').textContent = 'â³';
  document.getElementById('atalhos').style.display = 'none';

  addMsgUser(txt);
  addTyping();

  try {
    const r = await fetch('/ia/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        mensagem: txt,
        contextoLoja: /camisa|camiseta|loja|comprar|tamanho|roupa/i.test(txt)
      })
    });

    const d = await r.json();
    document.getElementById('typing')?.remove();

    if (r.status === 401) {
      localStorage.removeItem('pace_token');
      window.location.href = '/entrar.html';
      return;
    }

    addMsgIA(d.resposta || 'NÃ£o consegui responder agora, tenta de novo!');

  } catch(e) {
    document.getElementById('typing')?.remove();
    addMsgIA('Perdi a conexÃ£o por um segundo! Tenta de novo. ğŸ˜…');
  } finally {
    enviando = false;
    document.getElementById('btnEnviar').textContent = 'â†‘';
    input.focus();
  }
}

function rapido(txt) {
  input.value = txt;
  enviar();
}

// Carregar histÃ³rico
async function carregarHistorico() {
  try {
    const r = await fetch('/ia/historico', { headers: { Authorization:`Bearer ${token}` } });
    const d = await r.json();
    if (d.mensagens?.length) {
      d.mensagens.slice(-10).forEach(m => {
        if (m.role === 'user') addMsgUser(m.content);
        else if (m.role === 'assistant') addMsgIA(m.content);
      });
    }
  } catch {}
}

carregarHistorico();
input.focus();
</script>
</body>
</html>
