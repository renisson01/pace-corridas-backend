<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE IA ‚Äî Sua Amiga de Corrida</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f172a;}
#mensagens{scroll-behavior:smooth;}
.msg-ia{animation:slideIn .2s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.typing span{display:inline-block;width:6px;height:6px;border-radius:50%;background:#22c55e;margin:0 2px;animation:bounce 1s infinite;}
.typing span:nth-child(2){animation-delay:.2s;}
.typing span:nth-child(3){animation-delay:.4s;}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-8px)}}
</style>
</head>
<body class="text-white min-h-screen flex flex-col">

<header class="bg-slate-800 border-b border-slate-700 px-4 py-3 flex items-center gap-3 sticky top-0 z-40">
  <a href="/" class="text-slate-400 text-xl">‚Üê</a>
  <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center font-black text-black text-lg">ü§ñ</div>
  <div>
    <p class="font-black text-sm leading-none">PACE IA</p>
    <p class="text-xs text-green-400 leading-none mt-0.5">Sua amiga de corrida</p>
  </div>
  <a href="/ia-avatar.html" class="ml-auto text-xs text-slate-400 border border-slate-600 px-3 py-1.5 rounded-full">üë§ Meu perfil</a>
</header>

<!-- ATALHOS R√ÅPIDOS -->
<div id="atalhos" class="px-4 py-3 flex gap-2 overflow-x-auto border-b border-slate-800">
  <button onclick="enviarRapido('Preciso de ajuda para escolher uma camisa')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">üëï Quero uma camisa</button>
  <button onclick="enviarRapido('Como melhorar meu pace?')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">‚ö° Melhorar pace</button>
  <button onclick="enviarRapido('Tive uma les√£o, o que fa√ßo?')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">üè• Tive les√£o</button>
  <button onclick="enviarRapido('Como me preparar para uma maratona?')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">üèÜ Maratona</button>
  <button onclick="enviarRapido('Estou desmotivado para treinar')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">üí™ Motiva√ß√£o</button>
  <button onclick="enviarRapido('Me conta sobre nutri√ß√£o para corredores')" class="whitespace-nowrap bg-slate-800 border border-slate-700 text-xs px-3 py-2 rounded-full hover:border-green-500">ü•ó Nutri√ß√£o</button>
</div>

<!-- MENSAGENS -->
<div id="mensagens" class="flex-1 overflow-y-auto px-4 py-4 pb-32 space-y-4">
  <!-- Mensagem de boas vindas -->
  <div class="flex gap-3">
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-sm flex-shrink-0">ü§ñ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none p-3 max-w-xs">
      <p class="text-sm">Ol√°! üëã Sou a PACE IA, sua amiga pessoal de corrida!</p>
      <p class="text-sm mt-2">Estou aqui para te ajudar com treinos, sa√∫de, motiva√ß√£o, e tamb√©m com nossas camisas exclusivas. üëï</p>
      <p class="text-sm mt-2 text-green-400">Como posso te ajudar hoje?</p>
    </div>
  </div>
</div>

<!-- INPUT -->
<div class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 px-4 py-3 pb-safe">
  <div class="flex gap-2 max-w-2xl mx-auto">
    <input id="input" type="text" placeholder="Fale comigo..." maxlength="500"
      class="flex-1 bg-slate-800 border border-slate-600 rounded-2xl px-4 py-3 text-sm text-white outline-none focus:border-green-500 transition-colors"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();enviar()}">
    <button onclick="enviar()" id="btnEnviar"
      class="bg-green-500 text-black font-black w-12 h-12 rounded-2xl flex items-center justify-center text-xl transition-transform active:scale-95">
      ‚Üë
    </button>
  </div>
</div>

<script>
const token = localStorage.getItem('pace_token');
const me = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;
if (!token) window.location.href = '/entrar.html';

const msgs = document.getElementById('mensagens');
const input = document.getElementById('input');
let enviando = false;

// Carregar hist√≥rico
async function carregarHistorico() {
  try {
    const r = await fetch('/ia/historico', { headers: { Authorization:`Bearer ${token}` } });
    const d = await r.json();
    if (d.mensagens && d.mensagens.length > 0) {
      // Mostrar √∫ltimas 10 mensagens do hist√≥rico
      const ultimas = d.mensagens.slice(-10);
      ultimas.forEach(m => {
        if (m.role === 'user') adicionarMsgUser(m.content, false);
        else if (m.role === 'assistant') adicionarMsgIA(m.content, false);
      });
      msgs.scrollTop = msgs.scrollHeight;
    }
  } catch {}
}

function adicionarMsgUser(texto, scroll=true) {
  const div = document.createElement('div');
  div.className = 'flex justify-end';
  div.innerHTML = `
    <div class="bg-green-500 text-black rounded-2xl rounded-tr-none px-4 py-3 max-w-xs">
      <p class="text-sm font-medium">${texto.replace(/</g,'&lt;')}</p>
    </div>`;
  msgs.appendChild(div);
  if (scroll) msgs.scrollTop = msgs.scrollHeight;
}

function adicionarMsgIA(texto, scroll=true) {
  const div = document.createElement('div');
  div.className = 'flex gap-3 msg-ia';
  div.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-sm flex-shrink-0">ü§ñ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-xs">
      <p class="text-sm leading-relaxed">${texto.replace(/\n/g,'<br>').replace(/</g,'&lt;').replace(/&lt;br>/g,'<br>')}</p>
    </div>`;
  msgs.appendChild(div);
  if (scroll) msgs.scrollTop = msgs.scrollHeight;
}

function mostrarTyping() {
  const div = document.createElement('div');
  div.id = 'typing';
  div.className = 'flex gap-3';
  div.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-sm flex-shrink-0">ü§ñ</div>
    <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3">
      <div class="typing"><span></span><span></span><span></span></div>
    </div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function removerTyping() {
  document.getElementById('typing')?.remove();
}

// Verificar se mensagem √© sobre loja
function isContextoLoja(msg) {
  const lower = msg.toLowerCase();
  return lower.includes('camisa') || lower.includes('camiseta') || lower.includes('loja') || lower.includes('comprar') || lower.includes('tamanho') || lower.includes('roupa');
}

async function enviar() {
  const texto = input.value.trim();
  if (!texto || enviando) return;
  enviando = true;

  input.value = '';
  document.getElementById('btnEnviar').textContent = '‚è≥';
  document.getElementById('atalhos').style.display = 'none';

  adicionarMsgUser(texto);
  mostrarTyping();

  try {
    const r = await fetch('/ia/chat', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
      body: JSON.stringify({ mensagem: texto, contextoLoja: isContextoLoja(texto) })
    });
    const d = await r.json();
    removerTyping();
    adicionarMsgIA(d.resposta || 'Ops, erro ao responder.');
  } catch(e) {
    removerTyping();
    adicionarMsgIA('Tive um problema de conex√£o! Tenta de novo üòÖ');
  } finally {
    enviando = false;
    document.getElementById('btnEnviar').textContent = '‚Üë';
    input.focus();
  }
}

function enviarRapido(texto) {
  input.value = texto;
  enviar();
}

carregarHistorico();
</script>
</body>
</html>
