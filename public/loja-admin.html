<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE ‚Äî Admin Loja</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://upload-widget.cloudinary.com/global/all.js"></script>
<style>body{background:#0a0f1a;}</style>
</head>
<body class="text-white min-h-screen pb-20">

<header class="bg-slate-900 border-b border-slate-800 px-4 py-3 flex items-center gap-3">
  <a href="/" class="text-slate-400">‚Üê</a>
  <h1 class="font-black">Admin Loja PACE</h1>
  <a href="/admin-pedidos.html" class="ml-auto text-xs bg-slate-800 border border-slate-700 px-3 py-2 rounded-xl">üì¶ Pedidos</a>
</header>

<!-- AVISO CLOUDINARY -->
<div id="aviso-cloud" class="mx-4 mt-4 bg-blue-900/30 border border-blue-500/40 rounded-2xl p-4 text-sm hidden">
  <p class="font-black text-blue-400 mb-1">üì∏ Configure o upload de fotos</p>
  <p class="text-slate-300 text-xs">Para enviar fotos, crie uma conta gratuita em <a href="https://cloudinary.com" target="_blank" class="text-blue-400 underline">cloudinary.com</a> e cole seu Cloud Name abaixo:</p>
  <div class="flex gap-2 mt-2">
    <input id="cloud-name-input" type="text" placeholder="Seu Cloud Name (ex: meu-app)" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-xs text-white">
    <button onclick="salvarCloud()" class="bg-blue-500 text-white font-bold text-xs px-3 py-2 rounded-xl">Salvar</button>
  </div>
</div>

<!-- FORM NOVO PRODUTO -->
<section class="px-4 mt-4">
  <h2 class="font-black text-base mb-3">‚ûï Adicionar produto</h2>
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 space-y-3">
    <input id="p-nome" placeholder="Nome do produto *" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500">
    <textarea id="p-desc" placeholder="Descri√ß√£o" rows="2" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500 resize-none"></textarea>

    <div class="grid grid-cols-2 gap-3">
      <input id="p-preco" type="number" placeholder="Pre√ßo (R$) *" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500">
      <select id="p-cat" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
        <option value="camisa">Camisa</option>
        <option value="shorts">Shorts</option>
        <option value="bone">Bon√©</option>
        <option value="acessorio">Acess√≥rio</option>
      </select>
    </div>

    <!-- FOTO -->
    <div>
      <p class="text-xs text-slate-400 mb-2">Foto do produto</p>
      <div class="flex gap-2">
        <button onclick="uploadFoto()" id="btn-upload" class="flex-1 bg-slate-800 border border-dashed border-slate-600 rounded-xl py-4 text-sm text-slate-400 hover:border-green-500 hover:text-green-400 transition-colors">
          üì∏ Enviar foto
        </button>
        <input id="p-foto-url" placeholder="ou cole URL da foto" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-3 py-3 text-xs text-white placeholder-slate-500 outline-none focus:border-green-500">
      </div>
      <div id="preview-foto" class="mt-2 hidden">
        <img id="foto-preview-img" class="w-full h-40 object-cover rounded-xl">
        <p class="text-xs text-green-400 mt-1">‚úÖ Foto carregada</p>
      </div>
    </div>

    <!-- TAMANHOS/ESTOQUE -->
    <div>
      <p class="text-xs text-slate-400 mb-2">Estoque por tamanho</p>
      <div class="grid grid-cols-5 gap-2">
        <div v-for="t in tamanhos">
          <label class="text-xs text-slate-400 block text-center mb-1">PP</label>
          <input id="est-PP" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm text-white text-center outline-none focus:border-green-500">
        </div>
        <div><label class="text-xs text-slate-400 block text-center mb-1">P</label><input id="est-P" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div><label class="text-xs text-slate-400 block text-center mb-1">M</label><input id="est-M" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div><label class="text-xs text-slate-400 block text-center mb-1">G</label><input id="est-G" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div><label class="text-xs text-slate-400 block text-center mb-1">GG</label><input id="est-GG" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-2 py-1.5 text-sm text-white text-center outline-none focus:border-green-500"></div>
      </div>
    </div>

    <button onclick="salvarProduto()" id="btn-salvar" class="w-full py-3 rounded-2xl font-black text-black text-sm active:scale-95 transition-all" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
      Salvar produto
    </button>
  </div>
</section>

<!-- LISTA DE PRODUTOS -->
<section class="px-4 mt-6">
  <h2 class="font-black text-base mb-3">üì¶ Produtos cadastrados</h2>
  <div id="lista-produtos" class="space-y-3">
    <p class="text-slate-500 text-sm text-center py-4">Carregando...</p>
  </div>
</section>

<script>
const token = localStorage.getItem('pace_token');
if (!token) window.location.href = '/entrar.html';

let cloudName = localStorage.getItem('pace_cloud_name') || '';
let fotoUrl = '';

// Verificar se tem cloud name configurado
if (!cloudName) {
  document.getElementById('aviso-cloud').classList.remove('hidden');
}

function salvarCloud() {
  cloudName = document.getElementById('cloud-name-input').value.trim();
  if (cloudName) {
    localStorage.setItem('pace_cloud_name', cloudName);
    document.getElementById('aviso-cloud').classList.add('hidden');
    alert('‚úÖ Cloud Name salvo!');
  }
}

function uploadFoto() {
  if (!cloudName) {
    document.getElementById('aviso-cloud').classList.remove('hidden');
    alert('Configure seu Cloud Name primeiro!');
    return;
  }
  const widget = cloudinary.createUploadWidget({
    cloudName: cloudName,
    uploadPreset: 'pace_produtos',
    sources: ['local', 'camera'],
    multiple: false,
    cropping: true,
    croppingAspectRatio: 1,
    language: 'pt',
    text: { pt: { or: 'ou', menu: { files: 'Meus arquivos', camera: 'C√¢mera' } } }
  }, (error, result) => {
    if (result?.event === 'success') {
      fotoUrl = result.info.secure_url;
      document.getElementById('p-foto-url').value = fotoUrl;
      document.getElementById('foto-preview-img').src = fotoUrl;
      document.getElementById('preview-foto').classList.remove('hidden');
    }
  });
  widget.open();
}

// Monitorar URL manual
document.getElementById('p-foto-url').addEventListener('input', function() {
  const url = this.value.trim();
  if (url) {
    fotoUrl = url;
    document.getElementById('foto-preview-img').src = url;
    document.getElementById('preview-foto').classList.remove('hidden');
  }
});

async function salvarProduto() {
  const nome = document.getElementById('p-nome').value.trim();
  const preco = parseFloat(document.getElementById('p-preco').value);
  if (!nome || !preco) { alert('Preencha nome e pre√ßo!'); return; }

  const btn = document.getElementById('btn-salvar');
  btn.textContent = 'Salvando... ‚è≥';
  btn.disabled = true;

  const foto = fotoUrl || document.getElementById('p-foto-url').value.trim();

  try {
    const r = await fetch('/loja/produtos', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({
        nome, preco,
        descricao: document.getElementById('p-desc').value.trim(),
        categoria: document.getElementById('p-cat').value,
        imagem: foto || null,
        variantes: ['PP','P','M','G','GG'].map(t => ({
          tamanho: t,
          cor: 'Verde',
          estoque: parseInt(document.getElementById('est-'+t).value) || 0
        }))
      })
    });
    const d = await r.json();
    if (r.ok) {
      alert('‚úÖ Produto salvo!');
      document.getElementById('p-nome').value = '';
      document.getElementById('p-preco').value = '';
      document.getElementById('p-desc').value = '';
      document.getElementById('p-foto-url').value = '';
      document.getElementById('preview-foto').classList.add('hidden');
      fotoUrl = '';
      carregarProdutos();
    } else { alert('Erro: ' + (d.error || d.message || 'Desconhecido')); }
  } catch(e) { alert('Erro de conex√£o'); }
  finally { btn.textContent = 'Salvar produto'; btn.disabled = false; }
}

async function carregarProdutos() {
  try {
    const r = await fetch('/loja/produtos', { headers: {'Authorization':'Bearer '+token} });
    const produtos = await r.json();
    const el = document.getElementById('lista-produtos');
    if (!produtos?.length) { el.innerHTML='<p class="text-slate-500 text-sm text-center py-4">Nenhum produto ainda</p>'; return; }
    el.innerHTML = produtos.map(p => `
      <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden flex">
        ${p.imagem ? `<img src="${p.imagem}" class="w-24 h-24 object-cover flex-shrink-0">` : '<div class="w-24 h-24 bg-slate-800 flex items-center justify-center text-3xl flex-shrink-0">üëï</div>'}
        <div class="flex-1 p-3">
          <p class="font-black text-sm">${p.nome}</p>
          <p class="text-green-400 font-bold text-sm">R$ ${(p.preco||0).toFixed(2)}</p>
          <p class="text-xs text-slate-400">${p.categoria||''}</p>
          <button onclick="deletar('${p.id}')" class="mt-2 text-xs text-red-400">üóëÔ∏è Remover</button>
        </div>
      </div>`).join('');
  } catch { document.getElementById('lista-produtos').innerHTML='<p class="text-red-400 text-sm text-center py-4">Erro ao carregar</p>'; }
}

async function deletar(id) {
  if (!confirm('Remover produto?')) return;
  await fetch('/loja/produtos/'+id, { method:'DELETE', headers:{'Authorization':'Bearer '+token} });
  carregarProdutos();
}

carregarProdutos();
</script>
</body>
</html>
