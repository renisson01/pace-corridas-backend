<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PACE Admin â€” Loja</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0a0f1a;}
.grad{background:linear-gradient(135deg,#22c55e,#16a34a);}
::-webkit-scrollbar{display:none;}
</style>
</head>
<body class="text-white min-h-screen pb-20">

<header class="sticky top-0 z-40 px-4 py-3 flex items-center gap-3 bg-slate-900 border-b border-slate-800">
  <a href="/" class="text-slate-400 text-xl">â†</a>
  <h1 class="font-black text-lg">Admin Loja</h1>
  <a href="/admin-pedidos.html" class="ml-auto text-xs bg-orange-500/20 border border-orange-500/50 text-orange-400 px-3 py-2 rounded-xl font-bold">ğŸ“¦ Pedidos</a>
</header>

<!-- FORM PRODUTO -->
<section class="px-4 mt-4">
  <h2 class="font-black mb-3">â• Novo produto</h2>
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 space-y-3">

    <input id="p-nome" placeholder="Nome *" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500">
    <textarea id="p-desc" placeholder="DescriÃ§Ã£o" rows="2" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500 resize-none"></textarea>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-xs text-slate-400 block mb-1">PreÃ§o (R$) *</label>
        <input id="p-preco" type="number" step="0.01" placeholder="0.00" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
      </div>
      <div>
        <label class="text-xs text-slate-400 block mb-1">Categoria</label>
        <select id="p-cat" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
          <option value="camisa">ğŸ‘• Camisa</option>
          <option value="shorts">ğŸ©³ Shorts</option>
          <option value="bone">ğŸ§¢ BonÃ©</option>
          <option value="acessorio">âŒš AcessÃ³rio</option>
        </select>
      </div>
    </div>

    <!-- UPLOAD DE FOTO -->
    <div>
      <label class="text-xs text-slate-400 block mb-2">ğŸ“¸ Foto do produto</label>
      <input type="file" id="file-input" accept="image/*" class="hidden" onchange="previewFoto(this)">
      <div onclick="document.getElementById('file-input').click()"
        class="border-2 border-dashed border-slate-600 rounded-xl p-6 text-center cursor-pointer hover:border-green-500 transition-colors" id="drop-area">
        <div id="preview-container" class="hidden">
          <img id="preview-img" class="w-full max-h-48 object-cover rounded-xl mb-2">
          <p class="text-xs text-green-400">âœ… Foto selecionada â€” clique para trocar</p>
        </div>
        <div id="upload-placeholder">
          <p class="text-3xl mb-2">ğŸ“¸</p>
          <p class="text-sm text-slate-400 font-bold">Toque para escolher foto</p>
          <p class="text-xs text-slate-500 mt-1">JPG, PNG ou WebP atÃ© 10MB</p>
        </div>
      </div>
      <div id="upload-progress" class="hidden mt-2">
        <div class="bg-slate-800 rounded-full h-2">
          <div id="progress-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width:0%"></div>
        </div>
        <p class="text-xs text-slate-400 mt-1 text-center" id="progress-text">Enviando...</p>
      </div>
    </div>

    <!-- CORES -->
    <div>
      <label class="text-xs text-slate-400 block mb-2">Cores disponÃ­veis</label>
      <div class="flex gap-2 flex-wrap" id="cores-container">
        <label class="flex items-center gap-1.5 text-xs cursor-pointer"><input type="checkbox" value="Verde" checked class="accent-green-500"> Verde</label>
        <label class="flex items-center gap-1.5 text-xs cursor-pointer"><input type="checkbox" value="Preto" class="accent-green-500"> Preto</label>
        <label class="flex items-center gap-1.5 text-xs cursor-pointer"><input type="checkbox" value="Branco" class="accent-green-500"> Branco</label>
        <label class="flex items-center gap-1.5 text-xs cursor-pointer"><input type="checkbox" value="Azul" class="accent-green-500"> Azul</label>
        <label class="flex items-center gap-1.5 text-xs cursor-pointer"><input type="checkbox" value="Cinza" class="accent-green-500"> Cinza</label>
      </div>
    </div>

    <!-- ESTOQUE POR TAMANHO -->
    <div>
      <label class="text-xs text-slate-400 block mb-2">Estoque por tamanho</label>
      <div class="grid grid-cols-5 gap-2">
        <div class="text-center"><p class="text-xs text-slate-400 mb-1">PP</p><input id="e-PP" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div class="text-center"><p class="text-xs text-slate-400 mb-1">P</p><input id="e-P" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div class="text-center"><p class="text-xs text-slate-400 mb-1">M</p><input id="e-M" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div class="text-center"><p class="text-xs text-slate-400 mb-1">G</p><input id="e-G" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white text-center outline-none focus:border-green-500"></div>
        <div class="text-center"><p class="text-xs text-slate-400 mb-1">GG</p><input id="e-GG" type="number" value="10" min="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white text-center outline-none focus:border-green-500"></div>
      </div>
    </div>

    <button onclick="salvarProduto()" id="btn-salvar" class="w-full grad text-black font-black py-3 rounded-2xl text-sm active:scale-95 transition-all shadow-lg">
      ğŸ’¾ Salvar produto
    </button>
  </div>
</section>

<!-- LISTA -->
<section class="px-4 mt-6">
  <h2 class="font-black mb-3">ğŸ“¦ Produtos (<span id="total-produtos">0</span>)</h2>
  <div id="lista" class="space-y-3"></div>
</section>

<script>
const token = localStorage.getItem('pace_token');
if (!token) window.location.href = '/entrar.html';

let fotoUploadada = null;
const TAMANHOS = ['PP','P','M','G','GG'];

function previewFoto(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('preview-img').src = e.target.result;
    document.getElementById('preview-container').classList.remove('hidden');
    document.getElementById('upload-placeholder').classList.add('hidden');
  };
  reader.readAsDataURL(file);
  fotoUploadada = file;
}

async function enviarFoto() {
  if (!fotoUploadada) return null;
  
  document.getElementById('upload-progress').classList.remove('hidden');
  document.getElementById('progress-bar').style.width = '30%';
  document.getElementById('progress-text').textContent = 'Enviando foto...';

  const form = new FormData();
  form.append('file', fotoUploadada);

  try {
    document.getElementById('progress-bar').style.width = '70%';
    const r = await fetch('/upload/imagem', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token },
      body: form
    });
    const d = await r.json();
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-text').textContent = 'âœ… Foto enviada!';
    setTimeout(() => document.getElementById('upload-progress').classList.add('hidden'), 2000);
    return d.url;
  } catch(e) {
    document.getElementById('progress-text').textContent = 'âŒ Erro no upload';
    return null;
  }
}

async function salvarProduto() {
  const nome = document.getElementById('p-nome').value.trim();
  const preco = parseFloat(document.getElementById('p-preco').value);
  if (!nome || !preco) { alert('Preencha nome e preÃ§o!'); return; }

  const btn = document.getElementById('btn-salvar');
  btn.textContent = 'â³ Salvando...';
  btn.disabled = true;

  try {
    // Upload da foto primeiro
    const imgUrl = await enviarFoto();

    // Pegar cores selecionadas
    const cores = [...document.querySelectorAll('#cores-container input:checked')].map(c => c.value);
    if (!cores.length) cores.push('PadrÃ£o');

    // Montar variantes (cor x tamanho)
    const variantes = [];
    for (const cor of cores) {
      for (const tam of TAMANHOS) {
        variantes.push({ cor, tamanho: tam, estoque: parseInt(document.getElementById('e-'+tam).value) || 0 });
      }
    }

    const r = await fetch('/loja/produtos', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({
        nome, preco,
        descricao: document.getElementById('p-desc').value.trim(),
        categoria: document.getElementById('p-cat').value,
        imagem: imgUrl || null,
        variantes
      })
    });

    const d = await r.json();
    if (r.ok) {
      alert('âœ… Produto salvo com sucesso!');
      // Limpar form
      ['p-nome','p-desc','p-preco'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('preview-container').classList.add('hidden');
      document.getElementById('upload-placeholder').classList.remove('hidden');
      document.getElementById('file-input').value = '';
      fotoUploadada = null;
      carregarProdutos();
    } else {
      alert('Erro: ' + (d.error || d.message || 'Verifique os dados'));
    }
  } catch(e) {
    alert('Erro de conexÃ£o: ' + e.message);
  } finally {
    btn.textContent = 'ğŸ’¾ Salvar produto';
    btn.disabled = false;
  }
}

async function carregarProdutos() {
  try {
    const r = await fetch('/loja/produtos', { headers: {'Authorization':'Bearer '+token} });
    const produtos = await r.json();
    document.getElementById('total-produtos').textContent = produtos?.length || 0;
    const el = document.getElementById('lista');
    if (!produtos?.length) { el.innerHTML='<p class="text-slate-500 text-sm text-center py-6">Nenhum produto ainda. Cadastre o primeiro! ğŸ‘†</p>'; return; }
    el.innerHTML = produtos.map(p => `
      <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden flex gap-0">
        <div class="w-24 h-24 flex-shrink-0 bg-slate-800 flex items-center justify-center overflow-hidden">
          ${p.imagem ? `<img src="${p.imagem}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : '<span class="text-4xl">ğŸ‘•</span>'}
        </div>
        <div class="flex-1 p-3 min-w-0">
          <p class="font-black text-sm truncate">${p.nome}</p>
          <p class="text-green-400 font-bold">R$ ${parseFloat(p.preco||0).toFixed(2)}</p>
          <p class="text-xs text-slate-400">${p.categoria||''} Â· ${p.variantes?.length||0} variantes</p>
          <div class="flex gap-2 mt-2">
            <button onclick="toggleAtivo('${p.id}', ${p.ativo})" class="text-xs ${p.ativo?'text-green-400':'text-slate-500'} border ${p.ativo?'border-green-500/40':'border-slate-700'} px-2 py-1 rounded-lg">${p.ativo?'âœ… Ativo':'â¸ï¸ Inativo'}</button>
            <button onclick="deletar('${p.id}')" class="text-xs text-red-400 border border-red-500/30 px-2 py-1 rounded-lg">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>`).join('');
  } catch(e) { document.getElementById('lista').innerHTML='<p class="text-red-400 text-sm text-center py-4">Erro ao carregar</p>'; }
}

async function deletar(id) {
  if (!confirm('Remover este produto?')) return;
  await fetch('/loja/produtos/'+id, { method:'DELETE', headers:{'Authorization':'Bearer '+token} });
  carregarProdutos();
}

async function toggleAtivo(id, ativo) {
  await fetch('/loja/produtos/'+id, {
    method:'PATCH',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body: JSON.stringify({ ativo: !ativo })
  });
  carregarProdutos();
}

carregarProdutos();
</script>
</body>
</html>
