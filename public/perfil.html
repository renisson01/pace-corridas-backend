<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PACE â€” Meu Perfil</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0a0f1a;}
.grad{background:linear-gradient(135deg,#22c55e,#16a34a);}
.card-glass{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);}
::-webkit-scrollbar{display:none;}
</style>
</head>
<body class="text-white min-h-screen pb-24">

<header class="sticky top-0 z-40 px-4 py-3 flex items-center justify-between" style="background:rgba(10,15,26,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);">
  <h1 class="font-black text-lg">ğŸ‘¤ Meu Perfil</h1>
  <div class="flex gap-2">
    <a href="/meu-resultado.html" class="text-xs bg-green-500/20 border border-green-500/50 text-green-400 px-3 py-2 rounded-xl font-bold">+ Resultado</a>
    <button onclick="sair()" class="text-xs bg-slate-800 border border-slate-700 text-slate-400 px-3 py-2 rounded-xl">Sair</button>
  </div>
</header>

<div id="nao-logado" class="hidden px-4 py-20 text-center">
  <p class="text-5xl mb-4">ğŸ”’</p>
  <p class="font-black text-xl mb-2">FaÃ§a login</p>
  <p class="text-slate-400 text-sm mb-6">Para ver seu perfil, entre na sua conta</p>
  <a href="/entrar.html" class="inline-block grad text-black font-black px-8 py-4 rounded-2xl">Entrar agora</a>
</div>

<div id="conteudo" class="hidden">

  <!-- CARD PERFIL -->
  <div class="px-4 pt-4">
    <div class="card-glass rounded-3xl p-5">
      <div class="flex items-start gap-4">
        <div id="avatar" class="w-20 h-20 rounded-2xl grad flex items-center justify-center text-black font-black text-3xl flex-shrink-0">?</div>
        <div class="flex-1 min-w-0">
          <h2 id="nome" class="font-black text-xl leading-tight">â€”</h2>
          <p id="info-sub" class="text-slate-400 text-sm mt-0.5">â€”</p>
          <div id="nivel-badge" class="inline-block mt-2 text-xs font-black px-3 py-1.5 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">ğŸŒ± Iniciando</div>
        </div>
      </div>

      <!-- STATS -->
      <div class="grid grid-cols-3 gap-3 mt-4">
        <div class="bg-slate-800/50 rounded-2xl p-3 text-center">
          <p id="stat-provas" class="font-black text-xl text-green-400">0</p>
          <p class="text-xs text-slate-400 mt-0.5">Provas</p>
        </div>
        <div class="bg-slate-800/50 rounded-2xl p-3 text-center">
          <p id="stat-pontos" class="font-black text-xl text-green-400">0</p>
          <p class="text-xs text-slate-400 mt-0.5">Pontos</p>
        </div>
        <div class="bg-slate-800/50 rounded-2xl p-3 text-center">
          <p id="stat-posicao" class="font-black text-xl text-green-400">â€”</p>
          <p class="text-xs text-slate-400 mt-0.5">Ranking</p>
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="px-4 mt-4 flex gap-2 border-b border-slate-800 pb-3">
    <button onclick="setTab('resultados')" id="tab-resultados" class="tab text-sm font-black text-green-400 border-b-2 border-green-400 pb-1 px-2">ğŸ… Resultados</button>
    <button onclick="setTab('medalhas')"   id="tab-medalhas"   class="tab text-sm text-slate-500 px-2 pb-1 border-b-2 border-transparent">ğŸ¥‡ Medalhas</button>
    <button onclick="setTab('editar')"     id="tab-editar"     class="tab text-sm text-slate-500 px-2 pb-1 border-b-2 border-transparent">âœï¸ Editar</button>
  </div>

  <!-- RESULTADOS -->
  <div id="tab-resultados-content" class="px-4 mt-4 space-y-3">
    <div id="lista-resultados" class="space-y-2">
      <p class="text-slate-500 text-sm text-center py-6">Carregando resultados...</p>
    </div>
    <a href="/meu-resultado.html" class="flex items-center justify-center gap-2 card-glass rounded-2xl py-4 text-sm text-green-400 font-bold border border-dashed border-green-500/30 active:scale-95 transition-transform">
      + Adicionar resultado de corrida
    </a>
  </div>

  <!-- MEDALHAS -->
  <div id="tab-medalhas-content" class="px-4 mt-4 hidden">
    <p class="text-xs text-slate-500 mb-3 text-center">Conquistas baseadas nos seus resultados</p>
    <div id="lista-medalhas" class="grid grid-cols-3 gap-3"></div>
  </div>

  <!-- EDITAR -->
  <div id="tab-editar-content" class="px-4 mt-4 hidden space-y-3">
    <div class="card-glass rounded-2xl p-4 space-y-3">
      <h3 class="font-black text-sm">Dados pessoais</h3>
      <input id="edit-nome" placeholder="Nome completo" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
      <div class="grid grid-cols-2 gap-3">
        <select id="edit-genero" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
          <option value="">GÃªnero</option>
          <option value="M">Masculino</option>
          <option value="F">Feminino</option>
        </select>
        <input id="edit-idade" type="number" placeholder="Idade" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
      </div>
      <select id="edit-estado" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-green-500">
        <option value="">Estado</option>
        <option>AC</option><option>AL</option><option>AM</option><option>AP</option>
        <option>BA</option><option>CE</option><option>DF</option><option>ES</option>
        <option>GO</option><option>MA</option><option>MG</option><option>MS</option>
        <option>MT</option><option>PA</option><option>PB</option><option>PE</option>
        <option>PI</option><option>PR</option><option>RJ</option><option>RN</option>
        <option>RO</option><option>RR</option><option>RS</option><option>SC</option>
        <option selected>SE</option><option>SP</option><option>TO</option>
      </select>
      <button onclick="salvarPerfil()" class="w-full grad text-black font-black py-3 rounded-2xl text-sm active:scale-95">ğŸ’¾ Salvar</button>
    </div>

    <div class="card-glass rounded-2xl p-4">
      <h3 class="font-black text-sm mb-3">Links</h3>
      <a href="/ia-avatar.html" class="flex items-center justify-between py-2 border-b border-slate-800">
        <span class="text-sm">ğŸƒ Perfil PACE IA (medidas)</span>
        <span class="text-slate-400 text-xs">â†’</span>
      </a>
      <a href="/pacematch.html" class="flex items-center justify-between py-2">
        <span class="text-sm">ğŸ’œ PACE Match (parceiros)</span>
        <span class="text-slate-400 text-xs">â†’</span>
      </a>
    </div>
  </div>

</div>

<nav class="fixed bottom-0 left-0 right-0 z-50" style="background:rgba(10,15,26,0.95);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.08);">
  <div class="flex justify-around py-2">
    <a href="/" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
    <a href="/calendario.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
    <a href="/elite.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ†</span><span>Ranking</span></a>
    <a href="/loja.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ‘•</span><span>Loja</span></a>
    <a href="/ia.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸƒ</span><span>IA</span></a>
    <a href="/perfil.html" class="flex flex-col items-center text-xs text-green-400 py-1 px-3"><span class="text-xl">ğŸ‘¤</span><span class="font-bold">Perfil</span></a>
  </div>
</nav>

<script>
const token = localStorage.getItem('pace_token');
const user = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;

const MEDALHAS_DEF = [
  { id:'primeira', icon:'ğŸ½', nome:'Primeira Corrida', desc:'Registrou seu primeiro resultado', cond: r => r.length >= 1 },
  { id:'5provas',  icon:'â­', nome:'5 Provas',         desc:'Completou 5 corridas',             cond: r => r.length >= 5 },
  { id:'10provas', icon:'ğŸ†', nome:'Veterano',         desc:'10 provas completadas',             cond: r => r.length >= 10 },
  { id:'maratona', icon:'ğŸ…', nome:'Maratonista',      desc:'Completou uma maratona (42km)',     cond: r => r.some(x => x.distance?.includes('42')) },
  { id:'meia',     icon:'ğŸ¥ˆ', nome:'Meia Maratonista', desc:'Completou uma meia maratona',       cond: r => r.some(x => x.distance?.includes('21')) },
  { id:'sub5',     icon:'âš¡', nome:'Sub 5min/km',      desc:'Pace abaixo de 5min/km',           cond: r => r.some(x => x.pace && x.pace < '5:00') },
  { id:'podio',    icon:'ğŸ¥‡', nome:'PÃ³dio',            desc:'Top 3 em alguma prova',             cond: r => r.some(x => x.overallRank <= 3) },
  { id:'multidist',icon:'ğŸ—ºï¸', nome:'Explorador',       desc:'Correu 3 distÃ¢ncias diferentes',   cond: r => new Set(r.map(x=>x.distance)).size >= 3 },
  { id:'streak',   icon:'ğŸ”¥', nome:'Dedicado',         desc:'Resultados em anos consecutivos',  cond: r => r.length >= 3 },
];

if (!token) {
  document.getElementById('nao-logado').classList.remove('hidden');
} else {
  document.getElementById('conteudo').classList.remove('hidden');
  carregarPerfil();
}

async function carregarPerfil() {
  try {
    const r = await fetch('/auth/me', { headers:{'Authorization':'Bearer '+token} });
    const d = await r.json();
    if (!d.user) { sair(); return; }
    const u = d.user;

    // Avatar com iniciais
    const iniciais = u.name?.split(' ').slice(0,2).map(n=>n[0]).join('').toUpperCase() || '?';
    document.getElementById('avatar').textContent = iniciais;
    document.getElementById('nome').textContent = u.name || 'Atleta';
    document.getElementById('info-sub').textContent = [u.gender === 'M' ? 'ğŸ‘¨ Masculino' : u.gender === 'F' ? 'ğŸ‘© Feminino' : '', u.age ? u.age + ' anos' : '', u.state || ''].filter(Boolean).join(' Â· ');

    // Editar
    if (u.name) document.getElementById('edit-nome').value = u.name;
    if (u.gender) document.getElementById('edit-genero').value = u.gender;
    if (u.age) document.getElementById('edit-idade').value = u.age;
    if (u.state) document.getElementById('edit-estado').value = u.state;

    // Carregar resultados do atleta
    await carregarResultados(u.id || u.athleteId);
  } catch(e) { console.error(e); }
}

async function carregarResultados(userId) {
  try {
    const r = await fetch('/results/me', { headers:{'Authorization':'Bearer '+token} });
    const resultados = await r.json() || [];

    // Stats
    const pts = resultados.reduce((s,x)=>s+(x.points||0),0);
    document.getElementById('stat-provas').textContent = resultados.length;
    document.getElementById('stat-pontos').textContent = pts.toLocaleString('pt-BR');

    // NÃ­vel
    let nivel = 'ğŸŒ± Iniciando';
    if (pts >= 12000) nivel = 'â­ Elite Mundial';
    else if (pts >= 7000) nivel = 'ğŸ”¥ Elite Nacional';
    else if (pts >= 3000) nivel = 'ğŸ’ª Elite Regional';
    else if (pts >= 1000) nivel = 'ğŸ“ˆ Sub-Elite';
    else if (pts >= 100) nivel = 'ğŸƒ Ativo';
    document.getElementById('nivel-badge').textContent = nivel;

    // Ranking pessoal
    if (pts > 0) {
      const rank = await fetch('/ranking?limit=1000').then(r=>r.json()).catch(()=>[]);
      const pos = rank.findIndex(a => a.totalPoints <= pts) + 1;
      document.getElementById('stat-posicao').textContent = pos > 0 ? pos+'Âº' : 'â€”';
    }

    // Lista de resultados
    const el = document.getElementById('lista-resultados');
    if (!resultados.length) {
      el.innerHTML = `<div class="text-center py-8">
        <p class="text-4xl mb-2">ğŸƒ</p>
        <p class="text-slate-400 text-sm">Nenhum resultado ainda</p>
        <p class="text-slate-500 text-xs mt-1">Adicione seu primeiro resultado de corrida!</p>
      </div>`;
    } else {
      el.innerHTML = resultados.map(r => {
        const data = r.createdAt ? new Date(r.createdAt).toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'2-digit'}) : '';
        const icon = r.distance?.includes('42') ? 'ğŸ…' : r.distance?.includes('21') ? 'ğŸ¥ˆ' : 'ğŸƒ';
        return `<div class="card-glass rounded-2xl p-4 flex items-center gap-3">
          <span class="text-2xl">${icon}</span>
          <div class="flex-1">
            <p class="font-bold text-sm">${r.race?.name || 'Corrida'}</p>
            <p class="text-xs text-slate-400">${r.distance||''} Â· ${data}</p>
          </div>
          <div class="text-right">
            <p class="font-black text-green-400">${r.time||'â€”'}</p>
            ${r.overallRank ? `<p class="text-xs text-slate-400">${r.overallRank}Âº lugar</p>` : ''}
          </div>
        </div>`;
      }).join('');
    }

    // Medalhas
    const conquistadas = MEDALHAS_DEF.map(m => ({...m, conquistada: m.cond(resultados)}));
    document.getElementById('lista-medalhas').innerHTML = conquistadas.map(m => `
      <div class="card-glass rounded-2xl p-3 text-center ${m.conquistada ? '' : 'opacity-30'}">
        <div class="text-3xl mb-1">${m.icon}</div>
        <p class="text-xs font-black leading-tight">${m.nome}</p>
        <p class="text-xs text-slate-500 mt-0.5 leading-tight">${m.desc}</p>
        ${m.conquistada ? '<p class="text-xs text-green-400 mt-1 font-bold">âœ…</p>' : '<p class="text-xs text-slate-600 mt-1">ğŸ”’</p>'}
      </div>`).join('');

  } catch(e) {
    document.getElementById('lista-resultados').innerHTML = '<p class="text-slate-500 text-sm text-center py-4">Erro ao carregar resultados</p>';
  }
}

function setTab(tab) {
  ['resultados','medalhas','editar'].forEach(t => {
    document.getElementById('tab-'+t).className = 'tab text-sm text-slate-500 px-2 pb-1 border-b-2 border-transparent';
    document.getElementById('tab-'+t+'-content').classList.add('hidden');
  });
  document.getElementById('tab-'+tab).className = 'tab text-sm font-black text-green-400 border-b-2 border-green-400 pb-1 px-2';
  document.getElementById('tab-'+tab+'-content').classList.remove('hidden');
}

async function salvarPerfil() {
  try {
    const r = await fetch('/auth/update', {
      method: 'PATCH',
      headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
      body: JSON.stringify({
        name: document.getElementById('edit-nome').value,
        gender: document.getElementById('edit-genero').value,
        age: parseInt(document.getElementById('edit-idade').value) || null,
        state: document.getElementById('edit-estado').value,
      })
    });
    if (r.ok) {
      const d = await r.json();
      if (d.user) localStorage.setItem('pace_user', JSON.stringify(d.user));
      alert('âœ… Perfil salvo!');
      carregarPerfil();
    } else { alert('Erro ao salvar'); }
  } catch { alert('Erro de conexÃ£o'); }
}

function sair() {
  localStorage.removeItem('pace_token');
  localStorage.removeItem('pace_user');
  window.location.href = '/entrar.html';
}
</script>
</body>
</html>
