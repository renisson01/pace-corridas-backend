<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE â€” Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>body{background:#0f172a;}</style>
</head>
<body class="text-white min-h-screen pb-20">
<header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 px-4 py-3 flex justify-between items-center">
  <a href="/" class="text-green-400 font-black text-xl">PACE</a>
  <h1 class="font-bold text-sm">ğŸ“¸ Feed</h1>
  <button onclick="abrirNovoPost()" class="bg-green-500 text-black font-black text-xs px-3 py-1.5 rounded-full">+ Post</button>
</header>

<div id="modalPost" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end">
  <div class="bg-slate-800 w-full rounded-t-3xl p-5">
    <div class="flex justify-between items-center mb-4">
      <h2 class="font-black">Nova postagem</h2>
      <button onclick="fecharModal()" class="text-slate-400 text-2xl">âœ•</button>
    </div>
    <textarea id="postContent" placeholder="Compartilhe seu treino, corrida ou conquista... ğŸƒ"
      class="w-full bg-slate-700 rounded-xl p-3 text-sm border border-slate-600 outline-none focus:border-green-500 resize-none" rows="4"></textarea>
    <select id="postType" class="w-full mt-2 bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none" onchange="toggleRunFields()">
      <option value="post">ğŸ’¬ AtualizaÃ§Ã£o</option>
      <option value="run">ğŸƒ Corrida</option>
      <option value="treino">ğŸ’ª Treino</option>
      <option value="conquista">ğŸ† Conquista</option>
    </select>
    <div id="runFields" class="hidden mt-2 grid grid-cols-3 gap-2">
      <input id="postDistance" placeholder="Ex: 10km" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none">
      <input id="postTime" placeholder="Ex: 50:00" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none">
      <input id="postPace" placeholder="Ex: 5:00/km" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none">
    </div>
    <button onclick="publicar()" class="w-full mt-4 bg-green-500 text-black font-black py-3 rounded-xl">Publicar</button>
  </div>
</div>

<div class="max-w-lg mx-auto px-4 pt-4">
  <div id="loading" class="text-center py-12 text-slate-400"><div class="text-4xl mb-3">â³</div><p>Carregando feed...</p></div>
  <div id="feed" class="space-y-4 hidden"></div>
  <div id="vazio" class="hidden text-center py-16 text-slate-400">
    <div class="text-6xl mb-4">ğŸ“¸</div>
    <p class="font-black text-lg">Nenhuma postagem ainda</p>
    <p class="text-sm mt-2 text-slate-500">Seja o primeiro a compartilhar!</p>
    <button onclick="abrirNovoPost()" class="mt-6 bg-green-500 text-black font-black px-8 py-3 rounded-full">Criar primeira postagem</button>
  </div>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around py-2 z-50">
  <a href="/" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
  <a href="/calendario.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
  <a href="/social.html" class="flex flex-col items-center text-xs text-green-400 py-1 px-3"><span class="text-xl">ğŸ“¸</span><span>Feed</span></a>
  <a href="/pacematch.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ’š</span><span>Match</span></a>
  <a href="/perfil.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
</nav>

<script>
const token = localStorage.getItem('pace_token');
const me = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;

function toggleRunFields() {
  document.getElementById('runFields').classList.toggle('hidden', document.getElementById('postType').value !== 'run');
}
function abrirNovoPost() {
  if (!token) { window.location.href='/entrar.html'; return; }
  document.getElementById('modalPost').classList.remove('hidden');
}
function fecharModal() { document.getElementById('modalPost').classList.add('hidden'); }

async function publicar() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) return alert('Escreva algo!');
  try {
    const r = await fetch('/posts', { method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({
      content, type: document.getElementById('postType').value,
      distance: document.getElementById('postDistance')?.value||null,
      time: document.getElementById('postTime')?.value||null,
      pace: document.getElementById('postPace')?.value||null,
    })});
    if (r.ok) { fecharModal(); document.getElementById('postContent').value=''; loadFeed(); }
    else { const e = await r.json(); alert(e.error||'Erro ao publicar'); }
  } catch { alert('Erro de conexÃ£o'); }
}

function avatar(user) {
  if (user.photo) return `<img src="${user.photo}" class="w-10 h-10 rounded-full object-cover">`;
  const ini = user.name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase();
  return `<div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center font-black text-black">${ini}</div>`;
}

function renderPost(p) {
  const icons = {run:'ğŸƒ',treino:'ğŸ’ª',conquista:'ğŸ†',post:'ğŸ’¬'};
  const tempo = new Date(p.createdAt).toLocaleDateString('pt-BR',{day:'2-digit',month:'short'});
  const isMine = me && p.user.id === me.id;

  let runCard = '';
  if (p.type==='run' && (p.distance||p.time)) {
    runCard = `<div class="bg-slate-900 rounded-xl p-3 mb-3 flex gap-4 text-center">
      ${p.distance?`<div class="flex-1"><p class="text-green-400 font-black text-lg">${p.distance}</p><p class="text-xs text-slate-400">distÃ¢ncia</p></div>`:''}
      ${p.time?`<div class="flex-1"><p class="text-blue-400 font-black text-lg">${p.time}</p><p class="text-xs text-slate-400">tempo</p></div>`:''}
      ${p.pace?`<div class="flex-1"><p class="text-purple-400 font-black text-lg">${p.pace}</p><p class="text-xs text-slate-400">pace/km</p></div>`:''}
    </div>`;
  }

  const comentarios = (p.comments||[]).map(c=>`
    <div class="flex gap-2 text-xs mt-1">
      <span class="font-bold text-slate-300">${c.user.name.split(' ')[0]}</span>
      <span class="text-slate-400">${c.content}</span>
    </div>`).join('');

  return `
  <div class="bg-slate-800 border border-slate-700 rounded-2xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
        <a href="/usuario.html?id=${p.user.id}">${avatar(p.user)}</a>
        <div>
          <p class="font-bold text-sm">${p.user.name}${p.user.isPremium?' â­':''}</p>
          <p class="text-xs text-slate-400">${p.user.city||''}${p.user.state?'/'+p.user.state:''} Â· ${tempo}</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xl">${icons[p.type]||'ğŸ’¬'}</span>
        ${!isMine?`<button onclick="seguir('${p.user.id}',this)" class="text-xs font-bold text-green-400 border border-green-500 px-3 py-1 rounded-full">Seguir</button>`:''}
      </div>
    </div>
    ${runCard}
    <p class="text-sm text-slate-200 leading-relaxed">${p.content}</p>
    <div class="flex items-center gap-5 mt-4 pt-3 border-t border-slate-700">
      <button onclick="curtir('${p.id}',this)" class="flex items-center gap-1.5 text-sm transition-transform active:scale-125">
        <span>${p.likedByMe?'â¤ï¸':'ğŸ¤'}</span>
        <span class="like-count text-slate-400 text-xs">${p.likesCount||0}</span>
      </button>
      <button onclick="toggleComment('${p.id}')" class="flex items-center gap-1.5 text-slate-400 text-sm">
        <span>ğŸ’¬</span><span class="text-xs">${p.commentsCount||0}</span>
      </button>
      <button onclick="compartilhar('${p.user.name}','${p.content.substring(0,60)}')" class="ml-auto text-slate-400">â†—ï¸</button>
    </div>
    ${comentarios ? `<div class="mt-2">${comentarios}</div>` : ''}
    <div id="cmt-${p.id}" class="hidden mt-3 flex gap-2">
      <input placeholder="Adicionar comentÃ¡rio..." 
        class="flex-1 bg-slate-700 rounded-full px-4 py-2 text-xs border border-slate-600 outline-none focus:border-green-500"
        onkeydown="if(event.key==='Enter')comentar('${p.id}',this)">
    </div>
  </div>`;
}

async function curtir(postId, btn) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const r = await fetch(`/posts/${postId}/like`, {method:'POST', headers:{Authorization:`Bearer ${token}`}});
  const d = await r.json();
  btn.querySelector('span').textContent = d.liked ? 'â¤ï¸' : 'ğŸ¤';
  const cnt = btn.querySelector('.like-count');
  cnt.textContent = parseInt(cnt.textContent) + (d.liked ? 1 : -1);
}

async function seguir(userId, btn) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const r = await fetch(`/follow/${userId}`, {method:'POST', headers:{Authorization:`Bearer ${token}`}});
  const d = await r.json();
  btn.textContent = d.following ? 'Seguindo âœ“' : 'Seguir';
  btn.className = d.following
    ? 'text-xs font-bold text-slate-400 border border-slate-500 px-3 py-1 rounded-full'
    : 'text-xs font-bold text-green-400 border border-green-500 px-3 py-1 rounded-full';
}

function toggleComment(postId) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const el = document.getElementById(`cmt-${postId}`);
  el.classList.toggle('hidden');
  if (!el.classList.contains('hidden')) el.querySelector('input').focus();
}

async function comentar(postId, input) {
  const content = input.value.trim();
  if (!content) return;
  await fetch(`/posts/${postId}/comment`, {method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify({content})});
  input.value = '';
  loadFeed();
}

function compartilhar(nome, texto) {
  if (navigator.share) navigator.share({title:`${nome} no PACE`, text:texto, url:location.href});
}

async function loadFeed() {
  try {
    const r = await fetch('/feed', {headers: token ? {Authorization:`Bearer ${token}`} : {}});
    const posts = await r.json();
    document.getElementById('loading').classList.add('hidden');
    if (!Array.isArray(posts) || !posts.length) {
      document.getElementById('vazio').classList.remove('hidden');
      return;
    }
    document.getElementById('vazio').classList.add('hidden');
    document.getElementById('feed').classList.remove('hidden');
    document.getElementById('feed').innerHTML = posts.map(renderPost).join('');
  } catch { document.getElementById('loading').innerHTML = '<p class="text-red-400">âŒ Erro ao carregar</p>'; }
}

loadFeed();
</script>
</body>
</html>
