<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PACE â€” Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>body{background:#0f172a;} .fade-in{animation:fadeIn .3s ease;} @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}</style>
</head>
<body class="text-white min-h-screen pb-20">

<header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 px-4 py-3 flex justify-between items-center">
  <a href="/" class="text-green-400 font-black text-xl">PACE</a>
  <h1 class="font-bold text-sm">ğŸ“¸ Feed</h1>
  <button onclick="abrirModal()" class="bg-green-500 text-black font-black text-xs px-3 py-1.5 rounded-full">+ Post</button>
</header>

<!-- MODAL NOVO POST -->
<div id="modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end">
  <div class="bg-slate-800 w-full rounded-t-3xl p-5 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="font-black text-lg">Nova postagem</h2>
      <button onclick="fecharModal()" class="text-slate-400 text-2xl leading-none">âœ•</button>
    </div>

    <!-- Preview foto -->
    <div id="fotoPreview" class="hidden mb-3 relative">
      <img id="fotoImg" class="w-full rounded-xl max-h-48 object-cover">
      <button onclick="removerFoto()" class="absolute top-2 right-2 bg-black/60 text-white w-7 h-7 rounded-full text-sm">âœ•</button>
    </div>

    <textarea id="postContent" placeholder="Compartilhe seu treino, corrida ou conquista... ğŸƒ"
      class="w-full bg-slate-700 rounded-xl p-3 text-sm border border-slate-600 outline-none focus:border-green-500 resize-none mb-3" rows="4"></textarea>

    <!-- Tipo de post -->
    <select id="postType" onchange="toggleRunFields()" class="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2.5 text-sm text-white outline-none mb-3">
      <option value="post">ğŸ’¬ AtualizaÃ§Ã£o</option>
      <option value="run">ğŸƒ Corrida</option>
      <option value="treino">ğŸ’ª Treino</option>
      <option value="conquista">ğŸ† Conquista</option>
    </select>

    <!-- Campos de corrida -->
    <div id="runFields" class="hidden grid grid-cols-3 gap-2 mb-3">
      <input id="postDistance" placeholder="Ex: 10km" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none focus:border-green-500">
      <input id="postTime" placeholder="Ex: 50:00" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none focus:border-green-500">
      <input id="postPace" placeholder="5:00/km" class="bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-sm text-white outline-none focus:border-green-500">
    </div>

    <!-- BotÃµes de mÃ­dia -->
    <div class="flex gap-2 mb-4">
      <label class="flex-1 flex items-center justify-center gap-2 bg-slate-700 border border-slate-600 rounded-xl py-2.5 text-sm cursor-pointer hover:bg-slate-600">
        <span>ğŸ“·</span><span>CÃ¢mera</span>
        <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handleFoto(this)">
      </label>
      <label class="flex-1 flex items-center justify-center gap-2 bg-slate-700 border border-slate-600 rounded-xl py-2.5 text-sm cursor-pointer hover:bg-slate-600">
        <span>ğŸ–¼ï¸</span><span>Galeria</span>
        <input type="file" accept="image/*" class="hidden" onchange="handleFoto(this)">
      </label>
    </div>

    <button onclick="publicar()" id="btnPublicar" class="w-full bg-green-500 text-black font-black py-3 rounded-xl text-base">
      Publicar
    </button>
  </div>
</div>

<!-- FEED -->
<div class="max-w-lg mx-auto px-4 pt-4">
  <div id="loading" class="text-center py-16 text-slate-400">
    <div class="text-5xl mb-3">â³</div><p>Carregando feed...</p>
  </div>
  <div id="feed" class="space-y-4 hidden"></div>
  <div id="vazio" class="hidden text-center py-16 text-slate-400">
    <div class="text-6xl mb-4">ğŸ“¸</div>
    <p class="font-black text-xl">Feed vazio por enquanto</p>
    <p class="text-sm mt-2 text-slate-500">Seja o primeiro a postar!</p>
    <button onclick="abrirModal()" class="mt-6 bg-green-500 text-black font-black px-8 py-3 rounded-full text-base">Criar primeira postagem</button>
  </div>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around py-2 z-50">
  <a href="/" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
  <a href="/calendario.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
  <a href="/social.html" class="flex flex-col items-center text-xs text-green-400 py-1 px-3"><span class="text-xl">ğŸ“¸</span><span>Feed</span></a>
  <a href="/pacematch.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ’š</span><span>Match</span></a>
  <a href="/perfil.html" class="flex flex-col items-center text-xs text-slate-400 py-1 px-3"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
</nav>

<script>
const token = localStorage.getItem('pace_token');
const me = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;
let fotoBase64 = null;

function abrirModal() {
  if (!token) { window.location.href='/entrar.html'; return; }
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('postContent').focus();
}
function fecharModal() { document.getElementById('modal').classList.add('hidden'); }
function toggleRunFields() {
  document.getElementById('runFields').classList.toggle('hidden', document.getElementById('postType').value !== 'run');
}

function handleFoto(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('Foto muito grande! MÃ¡ximo 5MB'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    fotoBase64 = e.target.result;
    document.getElementById('fotoImg').src = fotoBase64;
    document.getElementById('fotoPreview').classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function removerFoto() {
  fotoBase64 = null;
  document.getElementById('fotoPreview').classList.add('hidden');
}

async function publicar() {
  const content = document.getElementById('postContent').value.trim();
  if (!content) { alert('Escreva algo antes de publicar!'); return; }

  const btn = document.getElementById('btnPublicar');
  btn.textContent = 'â³ Publicando...';
  btn.disabled = true;

  const body = {
    content,
    type: document.getElementById('postType').value,
    photo: fotoBase64 || null,
    distance: document.getElementById('postDistance')?.value || null,
    time: document.getElementById('postTime')?.value || null,
    pace: document.getElementById('postPace')?.value || null,
  };

  try {
    const r = await fetch('/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify(body)
    });
    const data = await r.json();

    if (r.ok) {
      fecharModal();
      document.getElementById('postContent').value = '';
      fotoBase64 = null;
      document.getElementById('fotoPreview').classList.add('hidden');
      await loadFeed();
    } else {
      alert(data.error || 'Erro ao publicar');
    }
  } catch(e) {
    alert('Erro de conexÃ£o: ' + e.message);
  } finally {
    btn.textContent = 'Publicar';
    btn.disabled = false;
  }
}

function avatar(user) {
  if (user.photo) return `<img src="${user.photo}" class="w-10 h-10 rounded-full object-cover">`;
  const ini = (user.name||'?').split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase();
  return `<div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center font-black text-black text-sm">${ini}</div>`;
}

function renderPost(p) {
  const icons = { run:'ğŸƒ', treino:'ğŸ’ª', conquista:'ğŸ†', post:'ğŸ’¬' };
  const tempo = new Date(p.createdAt).toLocaleDateString('pt-BR', { day:'2-digit', month:'short' });
  const isMine = me && p.user.id === me.id;

  let runCard = '';
  if (p.type === 'run' && (p.distance || p.time)) {
    runCard = `<div class="bg-slate-900 rounded-xl p-3 mb-3 flex gap-3 text-center">
      ${p.distance ? `<div class="flex-1"><p class="text-green-400 font-black">${p.distance}</p><p class="text-xs text-slate-400">distÃ¢ncia</p></div>` : ''}
      ${p.time ? `<div class="flex-1"><p class="text-blue-400 font-black">${p.time}</p><p class="text-xs text-slate-400">tempo</p></div>` : ''}
      ${p.pace ? `<div class="flex-1"><p class="text-purple-400 font-black">${p.pace}</p><p class="text-xs text-slate-400">pace/km</p></div>` : ''}
    </div>`;
  }

  const cmts = (p.comments||[]).slice(0,3).map(c =>
    `<div class="flex gap-2 text-xs mt-1.5">
      <span class="font-bold text-slate-200 shrink-0">${c.user.name.split(' ')[0]}</span>
      <span class="text-slate-400">${c.content}</span>
    </div>`
  ).join('');

  return `
  <div class="fade-in bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden">
    <div class="p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <a href="/usuario.html?id=${p.user.id}">${avatar(p.user)}</a>
          <div>
            <p class="font-bold text-sm">${p.user.name}${p.user.isPremium?' â­':''}</p>
            <p class="text-xs text-slate-400">${p.user.city||''}${p.user.state?'/'+p.user.state:''} Â· ${tempo}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xl">${icons[p.type]||'ğŸ’¬'}</span>
          ${!isMine ? `<button onclick="seguir('${p.user.id}',this)" class="text-xs font-bold text-green-400 border border-green-500 px-3 py-1 rounded-full">Seguir</button>` : ''}
        </div>
      </div>

      ${runCard}
      <p class="text-sm leading-relaxed text-slate-200">${p.content}</p>
    </div>

    ${p.photo ? `<img src="${p.photo}" class="w-full object-cover max-h-80">` : ''}

    <div class="px-4 py-3 border-t border-slate-700">
      <div class="flex items-center gap-5">
        <button onclick="curtir('${p.id}',this)" class="flex items-center gap-1.5 transition-transform active:scale-125">
          <span class="text-lg">${p.likedByMe?'â¤ï¸':'ğŸ¤'}</span>
          <span class="like-count text-xs text-slate-400">${p.likesCount||0}</span>
        </button>
        <button onclick="toggleCmt('${p.id}')" class="flex items-center gap-1.5 text-slate-400">
          <span>ğŸ’¬</span><span class="text-xs">${p.commentsCount||0}</span>
        </button>
        <button onclick="compartilhar('${p.user.name}','${p.content.substring(0,60).replace(/'/g,'')}')" class="ml-auto text-slate-400 text-lg">â†—ï¸</button>
      </div>

      ${cmts ? `<div class="mt-2">${cmts}</div>` : ''}

      <div id="cmt-${p.id}" class="hidden mt-3 flex gap-2">
        <input placeholder="Comentar..." maxlength="200"
          class="flex-1 bg-slate-700 rounded-full px-4 py-2 text-sm border border-slate-600 outline-none focus:border-green-500"
          onkeydown="if(event.key==='Enter')comentar('${p.id}',this)">
        <button onclick="comentar('${p.id}',this.previousElementSibling)" class="bg-green-500 text-black font-black px-3 py-2 rounded-full text-xs">â†’</button>
      </div>
    </div>
  </div>`;
}

async function curtir(postId, btn) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const r = await fetch(`/posts/${postId}/like`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } });
  const d = await r.json();
  const heart = btn.querySelector('span:first-child');
  const cnt = btn.querySelector('.like-count');
  heart.textContent = d.liked ? 'â¤ï¸' : 'ğŸ¤';
  cnt.textContent = parseInt(cnt.textContent) + (d.liked ? 1 : -1);
}

async function seguir(userId, btn) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const r = await fetch(`/follow/${userId}`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } });
  const d = await r.json();
  btn.textContent = d.following ? 'Seguindo âœ“' : 'Seguir';
  btn.className = d.following
    ? 'text-xs font-bold text-slate-400 border border-slate-500 px-3 py-1 rounded-full'
    : 'text-xs font-bold text-green-400 border border-green-500 px-3 py-1 rounded-full';
}

function toggleCmt(id) {
  if (!token) { window.location.href='/entrar.html'; return; }
  const el = document.getElementById(`cmt-${id}`);
  el.classList.toggle('hidden');
  if (!el.classList.contains('hidden')) el.querySelector('input').focus();
}

async function comentar(postId, input) {
  const content = input.value.trim();
  if (!content) return;
  input.value = '';
  await fetch(`/posts/${postId}/comment`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
    body: JSON.stringify({ content })
  });
  await loadFeed();
}

function compartilhar(nome, texto) {
  if (navigator.share) navigator.share({ title:`${nome} no PACE`, text: texto, url: location.href });
  else { navigator.clipboard.writeText(location.href); alert('Link copiado!'); }
}

async function loadFeed() {
  try {
    const r = await fetch('/feed', { headers: token ? { Authorization:`Bearer ${token}` } : {} });
    const posts = await r.json();
    document.getElementById('loading').classList.add('hidden');
    if (!Array.isArray(posts) || !posts.length) {
      document.getElementById('vazio').classList.remove('hidden');
      document.getElementById('feed').classList.add('hidden');
      return;
    }
    document.getElementById('vazio').classList.add('hidden');
    document.getElementById('feed').classList.remove('hidden');
    document.getElementById('feed').innerHTML = posts.map(renderPost).join('');
  } catch(e) {
    document.getElementById('loading').innerHTML = `<p class="text-red-400">âŒ Erro: ${e.message}</p>`;
  }
}

loadFeed();
</script>
</body>
</html>
