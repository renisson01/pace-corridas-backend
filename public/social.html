<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>PACE â€” Feed Social</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0a0f1a;}
.card-glass{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);}
.grad-green{background:linear-gradient(135deg,#22c55e,#16a34a);}
::-webkit-scrollbar{display:none;}
</style>
</head>
<body class="text-white min-h-screen pb-24">

<header class="sticky top-0 z-40 px-4 py-3 flex items-center justify-between" style="background:rgba(10,15,26,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.08);">
  <h1 class="font-black text-lg">ğŸ“¸ Feed</h1>
  <button onclick="abrirModal()" class="grad-green text-black font-black text-sm px-4 py-2 rounded-xl shadow-lg active:scale-95 transition-transform">+ Postar</button>
</header>

<!-- MODAL POSTAR -->
<div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);">
  <div class="w-full max-w-sm rounded-3xl overflow-hidden" style="background:#111827;border:1px solid rgba(255,255,255,0.1);">
    <div class="px-5 py-4 border-b border-slate-800 flex items-center justify-between">
      <h2 class="font-black">Nova publicaÃ§Ã£o</h2>
      <button onclick="fecharModal()" class="text-slate-400 text-2xl leading-none">Ã—</button>
    </div>
    <div class="p-5 space-y-4">
      <textarea id="post-texto" placeholder="O que vocÃª quer compartilhar? ğŸƒ" rows="4"
        class="w-full bg-slate-800 border border-slate-700 rounded-2xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500 resize-none transition-colors"></textarea>
      <div class="grid grid-cols-3 gap-2">
        <button onclick="setTipo('resultado')" id="tipo-resultado" class="tipo-btn bg-green-500/20 border border-green-500 text-green-400 text-xs py-2 rounded-xl font-bold">ğŸ… Resultado</button>
        <button onclick="setTipo('treino')"    id="tipo-treino"   class="tipo-btn bg-slate-800 border border-slate-700 text-slate-400 text-xs py-2 rounded-xl">ğŸ’ª Treino</button>
        <button onclick="setTipo('foto')"      id="tipo-foto"     class="tipo-btn bg-slate-800 border border-slate-700 text-slate-400 text-xs py-2 rounded-xl">ğŸ“¸ Foto</button>
      </div>
      <input id="post-img" type="url" placeholder="Link de foto (opcional)" class="w-full bg-slate-800 border border-slate-700 rounded-2xl px-4 py-3 text-sm text-white placeholder-slate-500 outline-none focus:border-green-500 transition-colors">
      <button onclick="publicar()" id="btn-publicar" class="w-full grad-green text-black font-black py-3 rounded-2xl text-sm active:scale-95 transition-all shadow-lg">Publicar ğŸš€</button>
    </div>
  </div>
</div>

<!-- FEED -->
<div class="max-w-2xl mx-auto px-4 py-4 space-y-4" id="feed">
  <div class="text-center py-8 text-slate-500">
    <div class="text-4xl mb-2">â³</div>
    <p class="text-sm">Carregando feed...</p>
  </div>
</div>

<nav class="fixed bottom-0 left-0 right-0 z-50" style="background:rgba(10,15,26,0.95);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.08);">
  <div class="flex justify-around py-2">
    <a href="/" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ </span><span>InÃ­cio</span></a>
    <a href="/calendario.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ“…</span><span>Corridas</span></a>
    <a href="/elite.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ†</span><span>Ranking</span></a>
    <a href="/loja.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ‘•</span><span>Loja</span></a>
    <a href="/ia.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸƒ</span><span>IA</span></a>
    <a href="/perfil.html" class="flex flex-col items-center text-xs text-slate-500 py-1 px-3"><span class="text-xl">ğŸ‘¤</span><span>Perfil</span></a>
  </div>
</nav>

<script>
const token = localStorage.getItem('pace_token');
const user = localStorage.getItem('pace_user') ? JSON.parse(localStorage.getItem('pace_user')) : null;
let tipoAtual = 'resultado';

function abrirModal() {
  if (!token) { window.location.href='/entrar.html'; return; }
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').classList.add('flex');
}
function fecharModal() {
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('flex');
}
function setTipo(t) {
  tipoAtual = t;
  document.querySelectorAll('.tipo-btn').forEach(b => {
    b.className = 'tipo-btn bg-slate-800 border border-slate-700 text-slate-400 text-xs py-2 rounded-xl';
  });
  const el = document.getElementById('tipo-'+t);
  el.className = 'tipo-btn bg-green-500/20 border border-green-500 text-green-400 text-xs py-2 rounded-xl font-bold';
}

async function publicar() {
  const texto = document.getElementById('post-texto').value.trim();
  const img = document.getElementById('post-img').value.trim();
  if (!texto) { alert('Escreve algo primeiro!'); return; }

  const btn = document.getElementById('btn-publicar');
  btn.textContent = 'Publicando... â³';
  btn.disabled = true;

  try {
    const r = await fetch('/social/posts', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({ content: texto, tipo: tipoAtual, imageUrl: img || null })
    });
    const d = await r.json();
    if (r.ok) {
      fecharModal();
      document.getElementById('post-texto').value = '';
      document.getElementById('post-img').value = '';
      carregarFeed();
    } else {
      alert(d.error || 'Erro ao publicar');
    }
  } catch(e) {
    alert('Erro de conexÃ£o');
  } finally {
    btn.textContent = 'Publicar ğŸš€';
    btn.disabled = false;
  }
}

async function curtir(postId, btn) {
  if (!token) { window.location.href='/entrar.html'; return; }
  try {
    const r = await fetch(`/social/posts/${postId}/like`, {
      method:'POST', headers:{'Authorization':'Bearer '+token}
    });
    const d = await r.json();
    btn.innerHTML = `â¤ï¸ ${d.likes||0}`;
  } catch {}
}

async function carregarFeed() {
  try {
    const r = await fetch('/social/posts?limit=20', { headers: token ? {'Authorization':'Bearer '+token} : {} });
    const posts = await r.json();
    const feed = document.getElementById('feed');

    if (!posts?.length) {
      feed.innerHTML = `<div class="text-center py-12">
        <div class="text-6xl mb-4">ğŸƒ</div>
        <p class="font-black text-lg mb-2">Seja o primeiro!</p>
        <p class="text-slate-400 text-sm mb-6">Compartilhe seu treino ou resultado de corrida</p>
        <button onclick="abrirModal()" class="grad-green text-black font-black px-6 py-3 rounded-2xl">Criar publicaÃ§Ã£o</button>
      </div>`;
      return;
    }

    feed.innerHTML = posts.map(p => {
      const data = new Date(p.createdAt).toLocaleDateString('pt-BR',{day:'2-digit',month:'short'});
      const hora = new Date(p.createdAt).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const tipo = p.tipo === 'resultado' ? 'ğŸ…' : p.tipo === 'treino' ? 'ğŸ’ª' : 'ğŸ“¸';
      const iniciais = (p.user?.name||'?').split(' ').slice(0,2).map(n=>n[0]).join('').toUpperCase();
      return `<div class="card-glass rounded-3xl overflow-hidden">
        <div class="p-4">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-full grad-green flex items-center justify-center text-black font-black text-sm flex-shrink-0">${iniciais}</div>
            <div class="flex-1">
              <p class="font-black text-sm">${p.user?.name||'Atleta'}</p>
              <p class="text-xs text-slate-500">${tipo} ${data} Ã s ${hora}</p>
            </div>
          </div>
          <p class="text-sm leading-relaxed">${p.content?.replace(/</g,'&lt;').replace(/\n/g,'<br>')||''}</p>
        </div>
        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full max-h-72 object-cover" onerror="this.style.display='none'">` : ''}
        <div class="px-4 py-3 border-t border-slate-800 flex gap-4">
          <button onclick="curtir('${p.id}',this)" class="text-sm text-slate-400 flex items-center gap-1.5 active:scale-95 transition-transform">â¤ï¸ ${p._count?.likes||p.likes||0}</button>
          <button class="text-sm text-slate-400 flex items-center gap-1.5">ğŸ’¬ ${p._count?.comments||0}</button>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('feed').innerHTML='<p class="text-center text-slate-500 py-8">Erro ao carregar feed</p>';
  }
}

carregarFeed();
// Fechar modal clicando fora
document.getElementById('modal').addEventListener('click', function(e) {
  if (e.target === this) fecharModal();
});
</script>
</body>
</html>
